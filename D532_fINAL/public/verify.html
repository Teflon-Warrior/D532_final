!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RecFlix - Verifying...</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css">
</head>
<body>
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6 text-center">
        <div class="spinner-border text-primary mb-3" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <h4>Verifying your session...</h4>
        <p id="statusMessage" class="text-muted">Please wait</p>
      </div>
    </div>
  </div>

  <script>
    // Cookie utility functions
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }

    function deleteCookie(name) {
      document.cookie = name + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
    }

    function clearAllCookies() {
      const cookies = ['recflix_user', 'recflix_email', 'recflix_token', 
                      'recflix_given_name', 'recflix_family_name', 
                      'recflix_picture', 'recflix_user_id'];
      cookies.forEach(cookie => deleteCookie(cookie));
    }

    // Verify session on page load
    async function verifySession() {
      const statusEl = document.getElementById('statusMessage');
      
      // Get stored credentials
      const email = getCookie('recflix_email');
      const token = getCookie('recflix_token');
      
      if (!email || !token) {
        statusEl.textContent = 'No session found. Redirecting to login...';
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
        return;
      }

      try {
        statusEl.textContent = 'Checking credentials with database...';
        
        // Verify with server
        const response = await fetch('/api/verify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, token })
        });

        const data = await response.json();

        if (response.ok && data.success && data.valid) {
          statusEl.textContent = 'Session verified! Welcome back, ' + data.user.name;
          statusEl.className = 'text-success';
          
          // Log user info
          console.log('Verified user:', data.user);
          console.log('User ID:', data.user.userId);
          console.log('Favorite genres:', data.user.favorite_genres);
          
          // Redirect to main page after 1 second
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 1000);
          
        } else {
          statusEl.textContent = 'Session expired or invalid. Redirecting to login...';
          statusEl.className = 'text-danger';
          
          // Clear invalid cookies
          clearAllCookies();
          
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
        }

      } catch (error) {
        console.error('Verification error:', error);
        statusEl.textContent = 'Error verifying session. Redirecting to login...';
        statusEl.className = 'text-danger';
        
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
      }
    }

    // Run verification when page loads
    verifySession();
  </script>
</body>
</html>