<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecFlix - Login</title>
    <script src="https://accounts.google.com/gsi/client" async></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <script>
      // Cookie utility functions
      function setCookie(name, value, days) {
        let expires = "";
        if (days) {
          const date = new Date();
          date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
          expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
      }

      function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for(let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      // Check if already logged in
      if (getCookie('recflix_user')) {
        window.location.href = 'index.html';
      }

      function decodeJWT(token) {
        let base64Url = token.split(".")[1];
        let base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
        let jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        return JSON.parse(jsonPayload);
      }

      function handleCredentialResponse(response) {
        console.log("Encoded JWT ID token: " + response.credential);

        const responsePayload = decodeJWT(response.credential);

        console.log("Decoded JWT ID token fields:");
        console.log("  Full Name: " + responsePayload.name);
        console.log("  Email: " + responsePayload.email);

        // Set cookies with user information
        setCookie('recflix_user', responsePayload.name, 30);
        setCookie('recflix_given_name', responsePayload.given_name, 30);
        setCookie('recflix_family_name', responsePayload.family_name, 30);
        setCookie('recflix_email', responsePayload.email, 30);
        setCookie('recflix_token', response.credential, 30);
        setCookie('recflix_picture', responsePayload.picture, 30);
        setCookie('recflix_user_id', responsePayload.sub, 30);

        // Redirect to main page
        window.location.href = 'index.html';
      }

      // Handle regular form login
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('form');
        const submitBtn = form.querySelector('button[type="submit"]');
        
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const username = document.getElementById('username').value;
          const password = document.getElementById('password').value;
          const errorDiv = document.getElementById('errorMessage');
          
          // Hide previous errors
          errorDiv.style.display = 'none';
          
          // Disable submit button and show loading
          submitBtn.disabled = true;
          submitBtn.textContent = 'Logging in...';
          
          try {
            // Call authentication API
            const response = await fetch('/api/login', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ username, password })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
              // Set cookies with user info from MongoDB
              setCookie('recflix_user', data.username, 30);
              setCookie('recflix_email', data.email, 30);
              setCookie('recflix_token', data.token, 30);
              setCookie('recflix_user_id', data.userId, 30);
              
              // Store additional user data
              if (data.age) setCookie('recflix_age', data.age, 30);
              if (data.favorite_genres) {
                setCookie('recflix_genres', JSON.stringify(data.favorite_genres), 30);
              }
              
              console.log('Login successful:', data);
              
              // Show success message
              errorDiv.className = 'alert alert-success';
              errorDiv.textContent = 'Login successful! Redirecting...';
              errorDiv.style.display = 'block';
              
              // Redirect to main page
              setTimeout(() => {
                window.location.href = 'index.html';
              }, 1000);
              
            } else {
              // Show error message
              errorDiv.className = 'alert alert-danger';
              errorDiv.textContent = data.message || 'Invalid username or password';
              errorDiv.style.display = 'block';
              
              // Re-enable button
              submitBtn.disabled = false;
              submitBtn.textContent = 'Login';
            }
          } catch (error) {
            console.error('Login error:', error);
            errorDiv.className = 'alert alert-danger';
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
            
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = 'Login';
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <h2 class="mb-4 text-center text-primary">RecFlix</h2>
                <h4 class="mb-4 text-center">Login</h4>
                
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                
                <form>
                    <div class="form-group">
                        <label for="username">Email</label>
                        <input type="email" class="form-control" id="username" name="username" placeholder="your@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
            </div>
        </div>
    </div>
  </body>
</html>